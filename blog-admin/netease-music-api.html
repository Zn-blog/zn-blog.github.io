<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç½‘æ˜“äº‘éŸ³ä¹å¯¼å…¥å·¥å…·ï¼ˆAPIç‰ˆæœ¬ï¼‰- åšå®¢ç®¡ç†åå°</title>
    <link rel="stylesheet" href="css/admin.css">
    <style>
        .netease-tool {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
        }

        .tool-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .tool-header h1 {
            color: #2c5f7c;
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .tool-header p {
            color: #666;
            font-size: 1rem;
        }

        .api-config {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }

        .api-config h3 {
            color: #856404;
            margin-bottom: 1rem;
        }

        .api-config input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }

        .api-config small {
            color: #856404;
            font-size: 0.85rem;
        }

        .input-section {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .input-section h2 {
            color: #333;
            font-size: 1.3rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .input-methods {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .input-method {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s;
        }

        .input-method:hover {
            border-color: #4fc3f7;
            box-shadow: 0 2px 8px rgba(79, 195, 247, 0.2);
        }

        .input-method h3 {
            color: #333;
            font-size: 1.1rem;
            margin-bottom: 1rem;
        }

        .input-method input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }

        .input-method button {
            width: 100%;
            padding: 0.75rem;
            background: linear-gradient(135deg, #4fc3f7 0%, #2c5f7c 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .input-method button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 195, 247, 0.3);
        }

        .input-method button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .help-text {
            color: #666;
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }

        .preview-section {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: none;
        }

        .preview-section.show {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .music-preview {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .preview-cover {
            width: 200px;
            height: 200px;
            border-radius: 12px;
            object-fit: cover;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .preview-info {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .preview-info h3 {
            font-size: 1.5rem;
            color: #333;
            margin: 0;
        }

        .preview-info .artist {
            color: #666;
            font-size: 1.1rem;
        }

        .preview-info .album {
            color: #999;
            font-size: 0.95rem;
        }

        .preview-info .duration {
            color: #4fc3f7;
            font-weight: 500;
        }

        .preview-audio audio {
            width: 100%;
            max-width: 400px;
            margin-top: 1rem;
        }

        .lyrics-preview {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 1.5rem;
        }

        .lyrics-preview h4 {
            color: #333;
            margin-bottom: 1rem;
        }

        .lyrics-preview pre {
            margin: 0;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.8;
            color: #555;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            padding-top: 1rem;
            border-top: 1px solid #eee;
        }

        .action-buttons button {
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-save {
            background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);
            color: white;
        }

        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .btn-cancel {
            background: #f5f5f5;
            color: #666;
        }

        .btn-cancel:hover {
            background: #e0e0e0;
        }

        .status-message {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }

        .status-message.show {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .status-message.info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }

        .back-link {
            display: inline-block;
            margin-bottom: 1rem;
            color: #4fc3f7;
            text-decoration: none;
            font-size: 0.95rem;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        .saved-list {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .saved-list h2 {
            color: #333;
            font-size: 1.3rem;
            margin-bottom: 1.5rem;
        }

        .saved-item {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.3s;
        }

        .saved-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .saved-item img {
            width: 60px;
            height: 60px;
            border-radius: 6px;
            object-fit: cover;
        }

        .saved-item-info {
            flex: 1;
        }

        .saved-item-info h4 {
            margin: 0 0 0.25rem 0;
            color: #333;
        }

        .saved-item-info p {
            margin: 0;
            color: #666;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="netease-tool">
        <a href="index.html" class="back-link">â† è¿”å›åå°ç®¡ç†</a>

        <div class="tool-header">
            <h1>ğŸµ ç½‘æ˜“äº‘éŸ³ä¹å¯¼å…¥å·¥å…·ï¼ˆå¢å¼ºç‰ˆï¼‰</h1>
            <p>é€šè¿‡æ­Œæ›²IDæˆ–é“¾æ¥å¿«é€Ÿå¯¼å…¥å®Œæ•´çš„æ­Œæ›²ä¿¡æ¯</p>
        </div>

        <!-- APIé…ç½® -->
        <div class="api-config">
            <h3>âš™ï¸ APIé…ç½®ï¼ˆå¯é€‰ï¼‰</h3>
            <input 
                type="text" 
                id="apiEndpoint" 
                placeholder="APIç«¯ç‚¹ï¼ˆç•™ç©ºä½¿ç”¨é»˜è®¤ï¼‰"
                value="https://netease-cloud-music-api-psi-ten-82.vercel.app"
            >
            <small>
                ğŸ’¡ æç¤ºï¼šå¦‚æœé»˜è®¤APIä¸å¯ç”¨ï¼Œå¯ä»¥éƒ¨ç½²è‡ªå·±çš„ 
                <a href="https://github.com/Binaryify/NeteaseCloudMusicApi" target="_blank" style="color: #856404;">ç½‘æ˜“äº‘éŸ³ä¹API</a>
            </small>
        </div>

        <div id="statusMessage" class="status-message"></div>

        <!-- è¾“å…¥åŒºåŸŸ -->
        <div class="input-section">
            <h2>ğŸ“ é€‰æ‹©å¯¼å…¥æ–¹å¼</h2>
            <div class="input-methods">
                <!-- æ–¹å¼1ï¼šæ­Œæ›²ID -->
                <div class="input-method">
                    <h3>æ–¹å¼1ï¼šæ­Œæ›²ID</h3>
                    <input 
                        type="text" 
                        id="musicId" 
                        placeholder="ä¾‹å¦‚ï¼š1868553"
                        onkeypress="if(event.key==='Enter') fetchById()"
                    >
                    <button onclick="fetchById()" id="fetchIdBtn">
                        ğŸ” è·å–ä¿¡æ¯
                    </button>
                    <div class="help-text">
                        è¾“å…¥çº¯æ•°å­—IDï¼Œå¦‚ï¼š1868553
                    </div>
                </div>

                <!-- æ–¹å¼2ï¼šæ­Œæ›²é“¾æ¥ -->
                <div class="input-method">
                    <h3>æ–¹å¼2ï¼šæ­Œæ›²é“¾æ¥</h3>
                    <input 
                        type="text" 
                        id="musicUrl" 
                        placeholder="ç²˜è´´ç½‘æ˜“äº‘éŸ³ä¹é“¾æ¥"
                        onkeypress="if(event.key==='Enter') fetchByUrl()"
                    >
                    <button onclick="fetchByUrl()" id="fetchUrlBtn">
                        ğŸ” è§£æé“¾æ¥
                    </button>
                    <div class="help-text">
                        æ”¯æŒå®Œæ•´é“¾æ¥æˆ–åˆ†äº«é“¾æ¥
                    </div>
                </div>
            </div>

            <div style="background: #e3f2fd; padding: 1rem; border-radius: 8px; font-size: 0.9rem;">
                <strong>ğŸ’¡ å¦‚ä½•è·å–ï¼Ÿ</strong><br>
                â€¢ <strong>æ–¹å¼1</strong>ï¼šæ‰“å¼€ç½‘æ˜“äº‘éŸ³ä¹ç½‘é¡µç‰ˆï¼Œä»URLä¸­å¤åˆ¶æ•°å­—ID<br>
                â€¢ <strong>æ–¹å¼2</strong>ï¼šåœ¨ç½‘æ˜“äº‘APPä¸­ç‚¹å‡»åˆ†äº«ï¼Œå¤åˆ¶é“¾æ¥ç›´æ¥ç²˜è´´
            </div>
        </div>

        <!-- é¢„è§ˆåŒºåŸŸ -->
        <div id="previewSection" class="preview-section"></div>

        <!-- å·²ä¿å­˜åˆ—è¡¨ -->
        <div class="saved-list">
            <h2>ğŸ“š æœ€è¿‘å¯¼å…¥çš„æ­Œæ›²</h2>
            <div id="savedList"></div>
        </div>
    </div>

    <script src="js/data-store.js"></script>
    <script>
        let currentMusicData = null;

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `status-message ${type} show`;
            
            setTimeout(() => {
                statusEl.classList.remove('show');
            }, 5000);
        }

        // é€šè¿‡IDè·å–
        async function fetchById() {
            const musicId = document.getElementById('musicId').value.trim();
            
            if (!musicId) {
                showStatus('âŒ è¯·è¾“å…¥æ­Œæ›²ID', 'error');
                return;
            }

            if (!/^\d+$/.test(musicId)) {
                showStatus('âŒ æ­Œæ›²IDå¿…é¡»æ˜¯çº¯æ•°å­—', 'error');
                return;
            }

            await fetchMusicInfo(musicId);
        }

        // é€šè¿‡URLè·å–
        async function fetchByUrl() {
            const url = document.getElementById('musicUrl').value.trim();
            
            if (!url) {
                showStatus('âŒ è¯·è¾“å…¥æ­Œæ›²é“¾æ¥', 'error');
                return;
            }

            // ä»URLä¸­æå–ID
            const idMatch = url.match(/id=(\d+)/);
            if (idMatch) {
                await fetchMusicInfo(idMatch[1]);
            } else {
                showStatus('âŒ æ— æ³•ä»é“¾æ¥ä¸­æå–æ­Œæ›²ID', 'error');
            }
        }

        // è·å–éŸ³ä¹ä¿¡æ¯
        async function fetchMusicInfo(musicId) {
            const fetchIdBtn = document.getElementById('fetchIdBtn');
            const fetchUrlBtn = document.getElementById('fetchUrlBtn');
            
            fetchIdBtn.disabled = true;
            fetchUrlBtn.disabled = true;
            fetchIdBtn.textContent = 'â³ è·å–ä¸­...';
            fetchUrlBtn.textContent = 'â³ è·å–ä¸­...';

            try {
                showStatus('ğŸ” æ­£åœ¨è·å–æ­Œæ›²ä¿¡æ¯...', 'info');

                const apiEndpoint = document.getElementById('apiEndpoint').value.trim() || 
                                  'https://netease-cloud-music-api-psi-ten-82.vercel.app';

                console.log('ä½¿ç”¨APIç«¯ç‚¹:', apiEndpoint);
                console.log('æ­Œæ›²ID:', musicId);

                // æµ‹è¯•APIè¿æ¥
                try {
                    const testResponse = await fetch(`${apiEndpoint}/`, { method: 'HEAD' });
                    console.log('APIè¿æ¥æµ‹è¯•:', testResponse.ok ? 'æˆåŠŸ' : 'å¤±è´¥');
                } catch (e) {
                    console.warn('APIè¿æ¥æµ‹è¯•å¤±è´¥:', e);
                }

                // è·å–æ­Œæ›²è¯¦æƒ…
                const detailUrl = `${apiEndpoint}/song/detail?ids=${musicId}`;
                console.log('è¯·æ±‚URL:', detailUrl);
                
                const detailResponse = await fetch(detailUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                console.log('å“åº”çŠ¶æ€:', detailResponse.status);
                
                if (!detailResponse.ok) {
                    throw new Error(`APIè¿”å›é”™è¯¯: ${detailResponse.status} ${detailResponse.statusText}`);
                }
                
                const detailData = await detailResponse.json();
                console.log('æ­Œæ›²è¯¦æƒ…æ•°æ®:', detailData);

                if (!detailData.songs || detailData.songs.length === 0) {
                    throw new Error('æœªæ‰¾åˆ°æ­Œæ›²ä¿¡æ¯ï¼Œè¯·æ£€æŸ¥æ­Œæ›²IDæ˜¯å¦æ­£ç¡®');
                }

                const song = detailData.songs[0];
                console.log('æ­Œæ›²ä¿¡æ¯:', song);

                // è·å–æ­Œè¯
                let lyrics = '';
                try {
                    const lyricUrl = `${apiEndpoint}/lyric?id=${musicId}`;
                    console.log('æ­Œè¯è¯·æ±‚URL:', lyricUrl);
                    
                    const lyricResponse = await fetch(lyricUrl);
                    if (lyricResponse.ok) {
                        const lyricData = await lyricResponse.json();
                        console.log('æ­Œè¯æ•°æ®:', lyricData);
                        lyrics = lyricData.lrc?.lyric || '';
                    }
                } catch (e) {
                    console.warn('æ­Œè¯è·å–å¤±è´¥:', e);
                    lyrics = '[00:00.00]æ­Œè¯è·å–å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æ·»åŠ ';
                }

                // æ•´ç†æ•°æ®
                const musicData = {
                    id: musicId,
                    name: song.name,
                    artist: song.ar.map(a => a.name).join('/'),
                    album: song.al.name,
                    cover: song.al.picUrl,
                    url: musicId,
                    duration: Math.floor(song.dt / 1000),
                    lrc: lyrics,
                    description: ''
                };

                console.log('æ•´ç†åçš„æ•°æ®:', musicData);

                currentMusicData = musicData;
                displayPreview(musicData);
                showStatus('âœ… æ­Œæ›²ä¿¡æ¯è·å–æˆåŠŸï¼', 'success');

            } catch (error) {
                console.error('è·å–å¤±è´¥è¯¦æƒ…:', error);
                
                // æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
                let errorMsg = 'è·å–å¤±è´¥: ' + error.message;
                
                if (error.message.includes('Failed to fetch')) {
                    errorMsg += '\n\nå¯èƒ½çš„åŸå› ï¼š\n1. APIæœåŠ¡å™¨ä¸å¯ç”¨\n2. ç½‘ç»œè¿æ¥é—®é¢˜\n3. CORSè·¨åŸŸé™åˆ¶\n\nå»ºè®®ï¼š\nâ€¢ å°è¯•æ›´æ¢APIç«¯ç‚¹\nâ€¢ æ£€æŸ¥ç½‘ç»œè¿æ¥\nâ€¢ ä½¿ç”¨åŸºç¡€ç‰ˆæ‰‹åŠ¨è¾“å…¥';
                }
                
                showStatus('âŒ ' + errorMsg, 'error');
                
                // æä¾›æ‰‹åŠ¨è¾“å…¥é€‰é¡¹
                if (confirm('è‡ªåŠ¨è·å–å¤±è´¥ï¼Œæ˜¯å¦ä½¿ç”¨æ‰‹åŠ¨è¾“å…¥æ¨¡å¼ï¼Ÿ')) {
                    showManualInput(musicId);
                }
            } finally {
                fetchIdBtn.disabled = false;
                fetchUrlBtn.disabled = false;
                fetchIdBtn.textContent = 'ğŸ” è·å–ä¿¡æ¯';
                fetchUrlBtn.textContent = 'ğŸ” è§£æé“¾æ¥';
            }
        }

        // æ‰‹åŠ¨è¾“å…¥æ¨¡å¼
        function showManualInput(musicId) {
            const musicData = {
                id: musicId,
                name: 'è¯·è¾“å…¥æ­Œæ›²åç§°',
                artist: 'è¯·è¾“å…¥æ­Œæ‰‹åç§°',
                album: 'è¯·è¾“å…¥ä¸“è¾‘åç§°',
                cover: 'https://p1.music.126.net/6y-UleORITEDbvrOLV0Q8A==/5639395138885805.jpg',
                url: musicId,
                duration: 240,
                lrc: '[00:00.00]è¯·è¾“å…¥æ­Œè¯',
                description: ''
            };

            currentMusicData = musicData;
            displayPreview(musicData, true); // true è¡¨ç¤ºå¯ç¼–è¾‘æ¨¡å¼
        }

        // æ˜¾ç¤ºé¢„è§ˆ
        function displayPreview(data, editable = false) {
            const previewSection = document.getElementById('previewSection');
            const audioUrl = `https://music.163.com/song/media/outer/url?id=${data.id}.mp3`;

            const editableAttr = editable ? 'contenteditable="true"' : '';
            const editableStyle = editable ? 'style="background: #fff3cd; padding: 0.25rem; border-radius: 4px; cursor: text;"' : '';

            previewSection.innerHTML = `
                <h2>ğŸµ æ­Œæ›²é¢„è§ˆ${editable ? ' <span style="color: #e74c3c; font-size: 0.9rem;">(å¯ç¼–è¾‘æ¨¡å¼)</span>' : ''}</h2>
                ${editable ? '<div style="background: #fff3cd; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #ffc107;"><strong>âš ï¸ æç¤ºï¼š</strong> ç‚¹å‡»è“è‰²åŒºåŸŸå¯ä»¥ç¼–è¾‘å†…å®¹</div>' : ''}
                <div class="music-preview">
                    <img src="${data.cover}" alt="${data.name}" class="preview-cover" 
                         onerror="this.src='https://via.placeholder.com/200x200/4fc3f7/ffffff?text=ğŸµ'">
                    <div class="preview-info">
                        <h3 ${editableAttr} ${editableStyle} id="editName">${data.name}</h3>
                        <div class="artist">ğŸ¤ <span ${editableAttr} ${editableStyle} id="editArtist">${data.artist}</span></div>
                        <div class="album">ğŸ’¿ <span ${editableAttr} ${editableStyle} id="editAlbum">${data.album}</span></div>
                        <div class="duration">â±ï¸ æ—¶é•¿: <span ${editableAttr} ${editableStyle} id="editDuration">${data.duration}</span> ç§’</div>
                        <div class="preview-audio">
                            <audio controls>
                                <source src="${audioUrl}" type="audio/mpeg">
                                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾
                            </audio>
                        </div>
                    </div>
                </div>

                <div class="lyrics-preview">
                    <h4>ğŸ“œ æ­Œè¯${editable ? 'ï¼ˆå¯ç¼–è¾‘ï¼‰' : ''}</h4>
                    <pre ${editableAttr} ${editableStyle} id="editLyrics">${data.lrc || '[00:00.00]æš‚æ— æ­Œè¯'}</pre>
                </div>

                <div style="background: #fff3cd; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <strong>ğŸ’¬ æ·»åŠ æè¿°ï¼ˆå¯é€‰ï¼‰</strong><br>
                    <textarea id="editDescription" style="width: 100%; margin-top: 0.5rem; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; min-height: 60px;" placeholder="æ·»åŠ æ­Œæ›²æè¿°ã€æ¨èç†ç”±ç­‰..."></textarea>
                </div>

                <div class="action-buttons">
                    <button class="btn-save" onclick="saveToBlog()">
                        ğŸ’¾ ä¿å­˜åˆ°åšå®¢
                    </button>
                    <button class="btn-cancel" onclick="cancelPreview()">
                        âŒ å–æ¶ˆ
                    </button>
                </div>
            `;

            previewSection.classList.add('show');
            previewSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // ä¿å­˜åˆ°åšå®¢
        function saveToBlog() {
            if (!currentMusicData) return;

            // è·å–å¯èƒ½è¢«ç¼–è¾‘çš„æ•°æ®
            const editName = document.getElementById('editName');
            const editArtist = document.getElementById('editArtist');
            const editAlbum = document.getElementById('editAlbum');
            const editDuration = document.getElementById('editDuration');
            const editLyrics = document.getElementById('editLyrics');

            const musicData = {
                ...currentMusicData,
                name: editName ? editName.textContent.trim() : currentMusicData.name,
                artist: editArtist ? editArtist.textContent.trim() : currentMusicData.artist,
                album: editAlbum ? editAlbum.textContent.trim() : currentMusicData.album,
                duration: editDuration ? parseInt(editDuration.textContent.trim()) : currentMusicData.duration,
                lrc: editLyrics ? editLyrics.textContent.trim() : currentMusicData.lrc,
                description: document.getElementById('editDescription')?.value.trim() || ''
            };

            // éªŒè¯å¿…å¡«é¡¹
            if (!musicData.name || musicData.name === 'è¯·è¾“å…¥æ­Œæ›²åç§°') {
                showStatus('âŒ è¯·è¾“å…¥æ­Œæ›²åç§°', 'error');
                editName?.focus();
                return;
            }
            if (!musicData.artist || musicData.artist === 'è¯·è¾“å…¥æ­Œæ‰‹åç§°') {
                showStatus('âŒ è¯·è¾“å…¥æ­Œæ‰‹åç§°', 'error');
                editArtist?.focus();
                return;
            }
            if (!musicData.duration || isNaN(musicData.duration) || musicData.duration <= 0) {
                showStatus('âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„æ—¶é•¿ï¼ˆç§’ï¼‰', 'error');
                editDuration?.focus();
                return;
            }

            try {
                window.blogDataStore.addMusic(musicData);
                showStatus(`âœ… ä¿å­˜æˆåŠŸï¼æ­Œæ›²ã€Š${musicData.name}ã€‹å·²æ·»åŠ åˆ°åšå®¢`, 'success');
                
                // æ¸…ç©ºè¾“å…¥
                document.getElementById('musicId').value = '';
                document.getElementById('musicUrl').value = '';
                
                // éšè—é¢„è§ˆ
                document.getElementById('previewSection').classList.remove('show');
                
                // æ›´æ–°åˆ—è¡¨
                updateSavedList();
                
                // æ»šåŠ¨åˆ°é¡¶éƒ¨
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                showStatus('âŒ ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }

        // å–æ¶ˆé¢„è§ˆ
        function cancelPreview() {
            document.getElementById('previewSection').classList.remove('show');
            currentMusicData = null;
        }

        // æ›´æ–°å·²ä¿å­˜åˆ—è¡¨
        function updateSavedList() {
            const savedList = document.getElementById('savedList');
            const music = window.blogDataStore.getMusic();

            if (music.length === 0) {
                savedList.innerHTML = '<p style="color: #999; text-align: center; padding: 2rem;">æš‚æ— å¯¼å…¥çš„æ­Œæ›²</p>';
                return;
            }

            const recentMusic = music.slice(0, 5);
            
            savedList.innerHTML = recentMusic.map(m => `
                <div class="saved-item">
                    <img src="${m.cover}" alt="${m.name}" 
                         onerror="this.src='https://via.placeholder.com/60x60/4fc3f7/ffffff?text=ğŸµ'">
                    <div class="saved-item-info">
                        <h4>${m.name}</h4>
                        <p>ğŸ¤ ${m.artist} | ğŸ’¿ ${m.album || 'æœªçŸ¥ä¸“è¾‘'} | â±ï¸ ${formatDuration(m.duration)}</p>
                    </div>
                    <button onclick="window.open('../blog/index.html', '_blank')" 
                            style="padding: 0.5rem 1rem; background: #4fc3f7; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        æŸ¥çœ‹å‰å°
                    </button>
                </div>
            `).join('');
        }

        // æ ¼å¼åŒ–æ—¶é•¿
        function formatDuration(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // é¡µé¢åŠ è½½æ—¶æ›´æ–°åˆ—è¡¨
        window.addEventListener('load', function() {
            updateSavedList();
        });
    </script>
</body>
</html>
