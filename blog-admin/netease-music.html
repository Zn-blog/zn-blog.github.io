<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç½‘æ˜“äº‘éŸ³ä¹å¯¼å…¥å·¥å…· - åšå®¢ç®¡ç†åå°</title>
    <link rel="stylesheet" href="css/admin.css">
    <style>
        .netease-tool {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
        }

        .tool-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .tool-header h1 {
            color: #2c5f7c;
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .tool-header p {
            color: #666;
            font-size: 1rem;
        }

        .input-section {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .input-section h2 {
            color: #333;
            font-size: 1.3rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .input-group {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .input-group input {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #4fc3f7;
            box-shadow: 0 0 0 3px rgba(79, 195, 247, 0.1);
        }

        .input-group button {
            padding: 0.75rem 2rem;
            background: linear-gradient(135deg, #4fc3f7 0%, #2c5f7c 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .input-group button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 195, 247, 0.3);
        }

        .input-group button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .help-text {
            color: #666;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .help-text a {
            color: #4fc3f7;
            text-decoration: none;
        }

        .help-text a:hover {
            text-decoration: underline;
        }

        .preview-section {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: none;
        }

        .preview-section.show {
            display: block;
        }

        .preview-section h2 {
            color: #333;
            font-size: 1.3rem;
            margin-bottom: 1.5rem;
        }

        .music-preview {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .preview-cover {
            width: 200px;
            height: 200px;
            border-radius: 12px;
            object-fit: cover;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .preview-info {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .preview-info h3 {
            font-size: 1.5rem;
            color: #333;
            margin: 0;
        }

        .preview-info .artist {
            color: #666;
            font-size: 1.1rem;
        }

        .preview-info .album {
            color: #999;
            font-size: 0.95rem;
        }

        .preview-info .duration {
            color: #4fc3f7;
            font-weight: 500;
        }

        .preview-audio {
            margin-top: 1rem;
        }

        .preview-audio audio {
            width: 100%;
            max-width: 400px;
        }

        .lyrics-preview {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 1.5rem;
        }

        .lyrics-preview h4 {
            color: #333;
            margin-bottom: 1rem;
        }

        .lyrics-preview pre {
            margin: 0;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.8;
            color: #555;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            padding-top: 1rem;
            border-top: 1px solid #eee;
        }

        .action-buttons button {
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-save {
            background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);
            color: white;
        }

        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .btn-cancel {
            background: #f5f5f5;
            color: #666;
        }

        .btn-cancel:hover {
            background: #e0e0e0;
        }

        .status-message {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }

        .status-message.show {
            display: block;
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .status-message.info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .saved-list {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .saved-list h2 {
            color: #333;
            font-size: 1.3rem;
            margin-bottom: 1.5rem;
        }

        .saved-item {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .saved-item img {
            width: 60px;
            height: 60px;
            border-radius: 6px;
            object-fit: cover;
        }

        .saved-item-info {
            flex: 1;
        }

        .saved-item-info h4 {
            margin: 0 0 0.25rem 0;
            color: #333;
        }

        .saved-item-info p {
            margin: 0;
            color: #666;
            font-size: 0.9rem;
        }

        .back-link {
            display: inline-block;
            margin-bottom: 1rem;
            color: #4fc3f7;
            text-decoration: none;
            font-size: 0.95rem;
        }

        .back-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="netease-tool">
        <a href="index.html" class="back-link">â† è¿”å›åå°ç®¡ç†</a>

        <div class="tool-header">
            <h1>ğŸµ ç½‘æ˜“äº‘éŸ³ä¹å¯¼å…¥å·¥å…·</h1>
            <p>é€šè¿‡ç½‘æ˜“äº‘éŸ³ä¹IDå¿«é€Ÿå¯¼å…¥æ­Œæ›²ä¿¡æ¯ã€å°é¢å’Œæ­Œè¯</p>
        </div>

        <div id="statusMessage" class="status-message"></div>

        <!-- è¾“å…¥åŒºåŸŸ -->
        <div class="input-section">
            <h2>ğŸ“ è¾“å…¥æ­Œæ›²ID</h2>
            <div class="input-group">
                <input 
                    type="text" 
                    id="musicId" 
                    placeholder="ä¾‹å¦‚ï¼š1868553"
                    onkeypress="if(event.key==='Enter') fetchMusicInfo()"
                >
                <button onclick="fetchMusicInfo()" id="fetchBtn">
                    ğŸ” è·å–ä¿¡æ¯
                </button>
            </div>
            <div class="help-text">
                ğŸ’¡ å¦‚ä½•è·å–æ­Œæ›²IDï¼Ÿ<br>
                1. æ‰“å¼€ <a href="https://music.163.com" target="_blank">ç½‘æ˜“äº‘éŸ³ä¹ç½‘é¡µç‰ˆ</a><br>
                2. æœç´¢å¹¶æ‰“å¼€æƒ³è¦çš„æ­Œæ›²<br>
                3. å¤åˆ¶æµè§ˆå™¨åœ°å€æ ä¸­çš„æ•°å­—ID<br>
                ä¾‹å¦‚ï¼šhttps://music.163.com/#/song?id=<strong>1868553</strong>
            </div>
        </div>

        <!-- é¢„è§ˆåŒºåŸŸ -->
        <div id="previewSection" class="preview-section">
            <h2>ğŸµ æ­Œæ›²é¢„è§ˆ</h2>
            <div id="previewContent"></div>
        </div>

        <!-- å·²ä¿å­˜åˆ—è¡¨ -->
        <div class="saved-list">
            <h2>ğŸ“š æœ€è¿‘å¯¼å…¥çš„æ­Œæ›²</h2>
            <div id="savedList"></div>
        </div>
    </div>

    <script src="js/data-store.js"></script>
    <script>
        let currentMusicData = null;

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `status-message ${type} show`;
            
            setTimeout(() => {
                statusEl.classList.remove('show');
            }, 5000);
        }

        // è·å–éŸ³ä¹ä¿¡æ¯
        async function fetchMusicInfo() {
            const musicId = document.getElementById('musicId').value.trim();
            
            if (!musicId) {
                showStatus('âŒ è¯·è¾“å…¥æ­Œæ›²ID', 'error');
                return;
            }

            if (!/^\d+$/.test(musicId)) {
                showStatus('âŒ æ­Œæ›²IDå¿…é¡»æ˜¯çº¯æ•°å­—', 'error');
                return;
            }

            const fetchBtn = document.getElementById('fetchBtn');
            fetchBtn.disabled = true;
            fetchBtn.textContent = 'â³ è·å–ä¸­...';

            try {
                showStatus('ğŸ” æ­£åœ¨è·å–æ­Œæ›²ä¿¡æ¯...', 'info');

                // ä½¿ç”¨ç½‘æ˜“äº‘éŸ³ä¹APIè·å–ä¿¡æ¯
                const musicData = await getMusicInfo(musicId);
                
                if (musicData) {
                    currentMusicData = musicData;
                    displayPreview(musicData);
                    showStatus('âœ… æ­Œæ›²ä¿¡æ¯è·å–æˆåŠŸï¼', 'success');
                } else {
                    showStatus('âŒ è·å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ­Œæ›²IDæ˜¯å¦æ­£ç¡®', 'error');
                }
            } catch (error) {
                console.error('è·å–å¤±è´¥:', error);
                showStatus('âŒ è·å–å¤±è´¥: ' + error.message, 'error');
            } finally {
                fetchBtn.disabled = false;
                fetchBtn.textContent = 'ğŸ” è·å–ä¿¡æ¯';
            }
        }

        // è·å–éŸ³ä¹ä¿¡æ¯ï¼ˆæ¨¡æ‹ŸAPIè°ƒç”¨ï¼‰
        async function getMusicInfo(musicId) {
            // æ³¨æ„ï¼šç”±äºè·¨åŸŸé™åˆ¶ï¼Œè¿™é‡Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
            // å®é™…ä½¿ç”¨æ—¶éœ€è¦åç«¯ä»£ç†æˆ–ä½¿ç”¨CORSä»£ç†
            
            try {
                // å°è¯•è·å–æ­Œæ›²è¯¦æƒ…
                const detailUrl = `https://music.163.com/api/song/detail/?id=${musicId}&ids=[${musicId}]`;
                
                // ç”±äºè·¨åŸŸé™åˆ¶ï¼Œè¿™é‡Œæä¾›ä¸€ä¸ªå¤‡ç”¨æ–¹æ¡ˆ
                // ç”¨æˆ·éœ€è¦æ‰‹åŠ¨è¾“å…¥æˆ–ä½¿ç”¨æµè§ˆå™¨æ’ä»¶
                
                // æ¨¡æ‹Ÿè¿”å›æ•°æ®ç»“æ„
                const mockData = {
                    id: musicId,
                    name: 'æ­Œæ›²åç§°ï¼ˆè¯·æ‰‹åŠ¨ä¿®æ”¹ï¼‰',
                    artist: 'æ­Œæ‰‹åç§°ï¼ˆè¯·æ‰‹åŠ¨ä¿®æ”¹ï¼‰',
                    album: 'ä¸“è¾‘åç§°ï¼ˆè¯·æ‰‹åŠ¨ä¿®æ”¹ï¼‰',
                    cover: `https://p1.music.126.net/6y-UleORITEDbvrOLV0Q8A==/5639395138885805.jpg`,
                    url: musicId,
                    duration: 240,
                    lrc: '[00:00.00]æ­Œè¯è·å–ä¸­...\n[00:05.00]è¯·æ‰‹åŠ¨ä¿®æ”¹æ­Œè¯',
                    description: ''
                };

                // å°è¯•ä»ç½‘æ˜“äº‘è·å–ï¼ˆå¯èƒ½å› è·¨åŸŸå¤±è´¥ï¼‰
                try {
                    const response = await fetch(`https://music.163.com/api/song/detail/?id=${musicId}&ids=[${musicId}]`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.songs && data.songs.length > 0) {
                            const song = data.songs[0];
                            return {
                                id: musicId,
                                name: song.name,
                                artist: song.artists.map(a => a.name).join('/'),
                                album: song.album.name,
                                cover: song.album.picUrl,
                                url: musicId,
                                duration: Math.floor(song.duration / 1000),
                                lrc: await getLyrics(musicId),
                                description: ''
                            };
                        }
                    }
                } catch (e) {
                    console.log('APIè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ¿æ•°æ®');
                }

                return mockData;
            } catch (error) {
                console.error('è·å–éŸ³ä¹ä¿¡æ¯å¤±è´¥:', error);
                throw error;
            }
        }

        // è·å–æ­Œè¯
        async function getLyrics(musicId) {
            try {
                const response = await fetch(`https://music.163.com/api/song/lyric?id=${musicId}&lv=1&kv=1&tv=-1`);
                if (response.ok) {
                    const data = await response.json();
                    return data.lrc?.lyric || '';
                }
            } catch (e) {
                console.log('æ­Œè¯è·å–å¤±è´¥');
            }
            return '[00:00.00]æ­Œè¯è·å–å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æ·»åŠ ';
        }

        // æ˜¾ç¤ºé¢„è§ˆ
        function displayPreview(data) {
            const previewSection = document.getElementById('previewSection');
            const previewContent = document.getElementById('previewContent');

            const audioUrl = `https://music.163.com/song/media/outer/url?id=${data.id}.mp3`;

            previewContent.innerHTML = `
                <div class="music-preview">
                    <img src="${data.cover}" alt="${data.name}" class="preview-cover" 
                         onerror="this.src='https://via.placeholder.com/200x200/4fc3f7/ffffff?text=ğŸµ'">
                    <div class="preview-info">
                        <h3 contenteditable="true" id="editName">${data.name}</h3>
                        <div class="artist">
                            ğŸ¤ <span contenteditable="true" id="editArtist">${data.artist}</span>
                        </div>
                        <div class="album">
                            ğŸ’¿ <span contenteditable="true" id="editAlbum">${data.album}</span>
                        </div>
                        <div class="duration">
                            â±ï¸ æ—¶é•¿: <span contenteditable="true" id="editDuration">${data.duration}</span> ç§’
                        </div>
                        <div class="preview-audio">
                            <audio controls>
                                <source src="${audioUrl}" type="audio/mpeg">
                                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾
                            </audio>
                        </div>
                    </div>
                </div>

                <div class="lyrics-preview">
                    <h4>ğŸ“œ æ­Œè¯ï¼ˆå¯ç¼–è¾‘ï¼‰</h4>
                    <pre contenteditable="true" id="editLyrics">${data.lrc}</pre>
                </div>

                <div style="background: #fff3cd; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <strong>ğŸ’¬ æè¿°ï¼ˆå¯é€‰ï¼‰</strong><br>
                    <textarea id="editDescription" style="width: 100%; margin-top: 0.5rem; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; min-height: 60px;" placeholder="æ·»åŠ æ­Œæ›²æè¿°ã€æ¨èç†ç”±ç­‰...">${data.description}</textarea>
                </div>

                <div style="background: #d1ecf1; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.9rem;">
                    <strong>ğŸ’¡ æç¤ºï¼š</strong><br>
                    â€¢ æ‰€æœ‰è“è‰²æ–‡å­—éƒ½å¯ä»¥ç›´æ¥ç‚¹å‡»ç¼–è¾‘<br>
                    â€¢ ç”±äºè·¨åŸŸé™åˆ¶ï¼Œéƒ¨åˆ†ä¿¡æ¯å¯èƒ½éœ€è¦æ‰‹åŠ¨ä¿®æ”¹<br>
                    â€¢ ç¡®è®¤ä¿¡æ¯æ— è¯¯åç‚¹å‡»"ä¿å­˜åˆ°åšå®¢"æŒ‰é’®
                </div>

                <div class="action-buttons">
                    <button class="btn-save" onclick="saveToBlog()">
                        ğŸ’¾ ä¿å­˜åˆ°åšå®¢
                    </button>
                    <button class="btn-cancel" onclick="cancelPreview()">
                        âŒ å–æ¶ˆ
                    </button>
                </div>
            `;

            previewSection.classList.add('show');
            previewSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // ä¿å­˜åˆ°åšå®¢
        function saveToBlog() {
            if (!currentMusicData) return;

            // è·å–ç¼–è¾‘åçš„æ•°æ®
            const musicData = {
                name: document.getElementById('editName').textContent.trim(),
                artist: document.getElementById('editArtist').textContent.trim(),
                album: document.getElementById('editAlbum').textContent.trim(),
                url: currentMusicData.id,
                cover: currentMusicData.cover,
                duration: parseInt(document.getElementById('editDuration').textContent.trim()),
                lrc: document.getElementById('editLyrics').textContent.trim(),
                description: document.getElementById('editDescription').value.trim()
            };

            // éªŒè¯å¿…å¡«é¡¹
            if (!musicData.name || !musicData.artist || !musicData.duration) {
                showStatus('âŒ è¯·å¡«å†™å®Œæ•´çš„æ­Œæ›²ä¿¡æ¯', 'error');
                return;
            }

            try {
                // ä¿å­˜åˆ°æ•°æ®å­˜å‚¨
                const result = window.blogDataStore.addMusic(musicData);
                
                showStatus(`âœ… ä¿å­˜æˆåŠŸï¼æ­Œæ›²ã€Š${musicData.name}ã€‹å·²æ·»åŠ åˆ°åšå®¢`, 'success');
                
                // æ¸…ç©ºè¾“å…¥
                document.getElementById('musicId').value = '';
                
                // éšè—é¢„è§ˆ
                document.getElementById('previewSection').classList.remove('show');
                
                // æ›´æ–°å·²ä¿å­˜åˆ—è¡¨
                updateSavedList();
                
                // æ»šåŠ¨åˆ°é¡¶éƒ¨
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                showStatus('âŒ ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }

        // å–æ¶ˆé¢„è§ˆ
        function cancelPreview() {
            document.getElementById('previewSection').classList.remove('show');
            currentMusicData = null;
        }

        // æ›´æ–°å·²ä¿å­˜åˆ—è¡¨
        function updateSavedList() {
            const savedList = document.getElementById('savedList');
            const music = window.blogDataStore.getMusic();

            if (music.length === 0) {
                savedList.innerHTML = '<p style="color: #999; text-align: center; padding: 2rem;">æš‚æ— å¯¼å…¥çš„æ­Œæ›²</p>';
                return;
            }

            // æ˜¾ç¤ºæœ€è¿‘5é¦–
            const recentMusic = music.slice(0, 5);
            
            savedList.innerHTML = recentMusic.map(m => `
                <div class="saved-item">
                    <img src="${m.cover}" alt="${m.name}" 
                         onerror="this.src='https://via.placeholder.com/60x60/4fc3f7/ffffff?text=ğŸµ'">
                    <div class="saved-item-info">
                        <h4>${m.name}</h4>
                        <p>ğŸ¤ ${m.artist} | ğŸ’¿ ${m.album || 'æœªçŸ¥ä¸“è¾‘'} | â±ï¸ ${formatDuration(m.duration)}</p>
                    </div>
                    <button onclick="viewInFrontend()" style="padding: 0.5rem 1rem; background: #4fc3f7; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        æŸ¥çœ‹å‰å°
                    </button>
                </div>
            `).join('');
        }

        // æ ¼å¼åŒ–æ—¶é•¿
        function formatDuration(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // æŸ¥çœ‹å‰å°
        function viewInFrontend() {
            window.open('../blog/index.html', '_blank');
        }

        // é¡µé¢åŠ è½½æ—¶æ›´æ–°åˆ—è¡¨
        window.addEventListener('load', function() {
            updateSavedList();
        });
    </script>
</body>
</html>
